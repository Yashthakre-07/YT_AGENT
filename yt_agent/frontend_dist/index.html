]<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NebulaAI — Futuristic Video Q&A</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

<style>
/* ================= THEME TOKENS ================= */
:root{
  --bg-dark: #03050a;
  --muted: #9fb0c8;
  --accentA: #7c3aed;  /* violet */
  --accentB: #00d4ff;  /* cyan */
  --accentC: #ff6b3d;  /* orange */
  --glass: rgba(255,255,255,0.03);
  --panel-grad: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.007));
  --text: #eaf3ff;
  --radius:14px;
}

/* ---------- Page & animated flowing gradient background ---------- */
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  background: #02020a;
  color:var(--text);
  font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  overflow-y:auto;
}

/* flowing gradient layers (behind content) */
.flow1, .flow2, .flow3{
  position:fixed; inset:-20%; z-index:-3; pointer-events:none; filter:blur(80px) saturate(120%);
  opacity:0.7;
  transform: translate3d(0,0,0);
}
.flow1{background: radial-gradient(600px 400px at 10% 10%, rgba(124,58,237,0.35), transparent 20%); animation: flowA 20s ease-in-out infinite;}
.flow2{background: radial-gradient(900px 500px at 90% 30%, rgba(0,212,255,0.18), transparent 20%); animation: flowB 22s ease-in-out infinite;}
.flow3{background: radial-gradient(700px 420px at 50% 90%, rgba(255,107,61,0.12), transparent 18%); animation: flowC 24s ease-in-out infinite;}
@keyframes flowA{0%{transform:translate(-8%, -4%) rotate(0deg)}50%{transform:translate(6%,6%) rotate(3deg)}100%{transform:translate(-8%,-4%) rotate(0deg)}}
@keyframes flowB{0%{transform:translate(6%,-6%) rotate(0deg)}50%{transform:translate(-6%,6%) rotate(-3deg)}100%{transform:translate(6%,-6%) rotate(0deg)}}
@keyframes flowC{0%{transform:translate(0,6%) rotate(0deg)}50%{transform:translate(0,-6%) rotate(2deg)}100%{transform:translate(0,6%) rotate(0deg)}}

/* ---------- layout ---------- */
.wrap{max-width:1240px;margin:22px auto;padding:18px}
.topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
.brand{display:flex;align-items:center;gap:14px}
.brand .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(90deg,var(--accentA),var(--accentB));display:flex;align-items:center;justify-content:center;box-shadow:0 18px 60px rgba(124,58,237,0.12)}
.brand h1{margin:0;font-family:"Space Mono", monospace;font-weight:700;letter-spacing:1px}
.brand small{display:block;color:var(--muted);font-size:12px}

/* main grid */
.grid{display:grid;grid-template-columns:380px 1fr;gap:18px;align-items:start}
@media (max-width:980px){ .grid{grid-template-columns:1fr} }

/* panel style */
.panel{background:var(--panel-grad);padding:16px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.03);box-shadow:0 20px 60px rgba(0,0,0,0.6)}
.label{font-size:13px;color:var(--muted);margin-bottom:6px;font-weight:600}
input[type="text"], textarea{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);outline:none;font-size:14px}
textarea{min-height:92px;resize:vertical}
.row{display:flex;gap:8px;align-items:center}

/* buttons */
.btn{padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);cursor:pointer;font-weight:700}
.btn.ghost{color:var(--muted)}
.btn.primary{background:linear-gradient(90deg,var(--accentA),var(--accentB));border:none;color:white;box-shadow:0 14px 44px rgba(124,58,237,0.12)}

/* status & mini processing */
.status{display:flex;gap:8px;align-items:center}
.dot{width:10px;height:10px;border-radius:50%;background:var(--muted)}
.dot.busy{background:var(--accentA);box-shadow:0 10px 30px rgba(124,58,237,0.2)}
.mini-processing{display:flex;gap:12px;align-items:center;margin-top:12px;opacity:0;max-height:0;overflow:hidden;transition:all .22s}
.mini-processing.show{opacity:1;max-height:120px;padding-top:12px}
.spinner{width:36px;height:36px;border-radius:999px;background:linear-gradient(90deg,var(--accentA),var(--accentB));box-shadow:0 18px 60px rgba(124,58,237,0.12);animation:spin 2s linear infinite}
@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}

/* right column (results) */
.result-area{display:flex;flex-direction:column;gap:14px}
.answer-card{background:linear-gradient(180deg, rgba(255,255,255,0.006), rgba(255,255,255,0.001));padding:18px;border-radius:12px;min-height:300px;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column}
.answer-header{display:flex;justify-content:space-between;align-items:center;gap:12px}
.answer-title{font-family:"Space Mono", monospace;font-weight:800;letter-spacing:0.8px;color:transparent;background:linear-gradient(90deg,var(--accentB),var(--accentA));-webkit-background-clip:text;background-clip:text;font-size:18px;margin:0}
.answer-body{margin-top:12px;flex:1;overflow:auto;padding-right:8px}

/* ******** FUTURISTIC ANSWER STYLE ******** */
.answer-body pre{
  margin:0;
  white-space:pre-wrap;
  word-break:break-word;
  font-family: "Space Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
  font-size:16px;
  line-height:1.65;
  color:#eaf6ff;
  background:linear-gradient(180deg, rgba(255,255,255,0.006), rgba(255,255,255,0.003));
  padding:18px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.03);
  box-shadow: 0 24px 80px rgba(1,8,20,0.6), inset 0 -6px 18px rgba(0,0,0,0.35);
  text-shadow: 0 1px 0 rgba(0,0,0,0.35);
  /* neon rim */
  box-shadow: 0 24px 80px rgba(1,8,20,0.6), 0 0 24px rgba(124,58,237,0.03);
  border-left: 4px solid rgba(124,58,237,0.18);
}

/* summary card: hidden by default */
.summary-card{padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);background:rgba(0,0,0,0.14);min-height:80px;display:none}
.summary-card.show{display:block}

/* overlay: large processing card */
.overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.8));backdrop-filter: blur(6px);z-index:999;opacity:0;pointer-events:none;transition:opacity .16s}
.overlay.show{opacity:1;pointer-events:auto}
.overlay-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:28px;border-radius:18px;display:flex;gap:18px;align-items:center;box-shadow:0 40px 120px rgba(2,6,23,0.75);border:1px solid rgba(255,255,255,0.03)}
.overlay-logo{width:120px;height:120px;border-radius:18px;display:flex;align-items:center;justify-content:center;background:linear-gradient(90deg,var(--accentA),var(--accentB));box-shadow:0 30px 80px rgba(124,58,237,0.14)}
.overlay-text .big{font-family:"Space Mono", monospace;font-weight:800;font-size:20px;margin-bottom:6px}
.overlay-dots{font-size:16px;color:var(--muted)}
.pulse{width:12px;height:12px;border-radius:50%;background:white;margin-right:8px;box-shadow:0 6px 24px rgba(124,58,237,0.18);animation:pulse 1.2s infinite}
@keyframes pulse{0%{transform:scale(1);opacity:0.9}50%{transform:scale(1.6);opacity:0.45}100%{transform:scale(1);opacity:0.9}}

/* log */
.log{margin-top:12px;background:rgba(0,0,0,0.16);padding:10px;border-radius:10px;color:var(--muted);height:140px;overflow:auto;font-size:13px}

/* small responsive */
@media (max-width:980px){
  .grid{grid-template-columns:1fr}
  .overlay-card{flex-direction:column;text-align:center}
  .overlay-logo{width:100px;height:100px}
}
</style>
</head>
<body>

<!-- animated flows -->
<div class="flow1"></div>
<div class="flow2"></div>
<div class="flow3"></div>

<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <svg width="34" height="34" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
          <defs><linearGradient id="gN" x1="0" x2="1"><stop offset="0" stop-color="#7c3aed"/><stop offset="1" stop-color="#00d4ff"/></linearGradient></defs>
          <rect width="48" height="48" rx="10" fill="url(#gN)"></rect>
          <path d="M14 24h20M24 14v20" stroke="#fff" stroke-width="2.6" stroke-linecap="round"/>
        </svg>
      </div>
      <div>
        <h1>NebulaAI</h1>
        <small>Futuristic Video Q&A • RAG-powered</small>
      </div>
    </div>

    <div>
      <button class="btn ghost" onclick="location.reload()">Reload</button>
      <button class="btn primary" onclick="document.getElementById('videoId').focus()">New Query</button>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT: controls -->
    <div class="panel">
      <div class="label">YouTube Video ID</div>
      <div class="row" style="gap:10px">
        <input id="videoId" type="text" placeholder="Gfr50f6ZBvo">
        <button id="previewBtn" class="btn ghost">Preview</button>
      </div>

      <div style="height:12px"></div>

      <div class="label">Question</div>
      <textarea id="question" placeholder="Ask something about the video...">summary</textarea>

      <div class="controls-footer">
        <button id="askBtn" class="btn primary">Ask Nebula</button>
        <button id="clearBtn" class="btn ghost">Clear</button>
        <div style="flex:1"></div>
        <div class="status"><div id="dot" class="dot"></div><small id="statusText" class="muted">Idle</small></div>
      </div>

      <div id="miniProc" class="mini-processing">
        <div class="spinner" aria-hidden="true"></div>
        <div>
          <div class="muted">Pipeline active</div>
          <div class="muted small">Transcript → Embeddings → Retrieval → LLM</div>
        </div>
      </div>

      <div style="height:14px"></div>

      <div class="label">Preview</div>
      <div id="videoPreview" style="border-radius:10px;overflow:hidden;background:linear-gradient(90deg, rgba(124,58,237,0.06), rgba(0,212,255,0.04));height:180px;display:flex;align-items:center;justify-content:center" class="muted">
        <div id="videoWrap">No preview</div>
      </div>

      <div style="height:12px"></div>

      <div class="label">Debug Log</div>
      <pre id="log" class="log">Ready.</pre>
    </div>

    <!-- RIGHT: results -->
    <div class="result-area">
      <div class="answer-card">
        <div class="answer-header">
          <div>
            <div class="answer-title">Answer</div>
            <div class="muted small">Readable, large, and selectable answer text</div>
          </div>

          <div class="controls-actions">
            <button id="copyBtn" class="btn">Copy</button>
            <button id="downloadBtn" class="btn ghost">Download</button>
            <button id="toggleSummaryBtn" class="btn ghost">Show Summary</button>
          </div>
        </div>

        <div class="answer-body" id="answerBody"><pre id="answerText">No answer yet — ask NebulaAI.</pre></div>
      </div>

      <div id="summaryCard" class="summary-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Summary</strong><div class="muted small">Concise summary</div></div>
          <div></div>
        </div>
        <div style="margin-top:10px" id="summaryText">—</div>
      </div>
    </div>
  </div>
</div>

<!-- overlay -->
<div id="overlay" class="overlay" aria-hidden="true">
  <div class="overlay-card">
    <div class="overlay-logo" aria-hidden="true">
      <svg width="84" height="84" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <defs><linearGradient id="gO" x1="0" x2="1"><stop offset="0" stop-color="#7c3aed"/><stop offset="1" stop-color="#00d4ff"/></linearGradient></defs>
        <circle cx="50" cy="50" r="38" fill="url(#gO)"/>
      </svg>
    </div>
    <div class="overlay-text">
      <div class="big">Nebula is processing</div>
      <div class="muted small">Fetching transcript, building embeddings, querying model — please wait.</div>
      <div style="height:10px"></div>
      <div style="display:flex;align-items:center">
        <div class="pulse" aria-hidden="true"></div>
        <div class="overlay-dots" id="overlayDots">Working<span id="overlayDotsText">...</span></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- UI wiring ---------- */
const videoIdEl = document.getElementById('videoId');
const questionEl = document.getElementById('question');
const askBtn = document.getElementById('askBtn');
const clearBtn = document.getElementById('clearBtn');
const previewBtn = document.getElementById('previewBtn');
const videoWrap = document.getElementById('videoWrap');
const logEl = document.getElementById('log');
const overlay = document.getElementById('overlay');
const overlayDotsText = document.getElementById('overlayDotsText');
const miniProc = document.getElementById('miniProc');
const dot = document.getElementById('dot');
const statusText = document.getElementById('statusText');
const answerTextEl = document.getElementById('answerText');
const summaryTextEl = document.getElementById('summaryText');
const copyBtn = document.getElementById('copyBtn');
const downloadBtn = document.getElementById('downloadBtn');
const toggleSummaryBtn = document.getElementById('toggleSummaryBtn');
const summaryCard = document.getElementById('summaryCard');

let overlayInterval = null;
let minShowMs = 600; // keep overlay visible at least this long

function log(msg){
  const t = new Date().toLocaleTimeString();
  logEl.textContent += `\n[${t}] ${msg}`;
  logEl.scrollTop = logEl.scrollHeight;
  console.log(msg);
}

function showOverlay(){
  overlay.classList.add('show');
  miniProc.classList.add('show');
  dot.classList.add('busy');
  statusText.textContent = 'Processing';
  let i = 0;
  overlayInterval = setInterval(()=>{ i=(i+1)%4; overlayDotsText.textContent = '.'.repeat(i); },420);
}
function hideOverlay(){
  overlay.classList.remove('show');
  miniProc.classList.remove('show');
  dot.classList.remove('busy');
  statusText.textContent = 'Idle';
  if(overlayInterval) clearInterval(overlayInterval);
  overlayDotsText.textContent = '...';
}

function setAnswer(text){ answerTextEl.textContent = text || '[no answer]'; }
function setSummary(text){ summaryTextEl.textContent = text || ''; }

previewBtn.addEventListener('click', () => {
  const raw = (videoIdEl.value || '').trim();
  if (!raw) {
    alert('Enter video id or YouTube URL to preview');
    return;
  }

  // Try to extract a clean video id from many possible formats
  let id = raw;
  try {
    // If it looks like a URL, try parsing
    if (raw.includes('youtube.com') || raw.includes('youtu.be') || raw.startsWith('http')) {
      const u = new URL(raw.startsWith('http') ? raw : 'https://' + raw);
      if (u.hostname.includes('youtu.be')) {
        id = u.pathname.slice(1);
      } else {
        // common parameter v
        id = u.searchParams.get('v') || id;
        // sometimes the id is in the path (rare)
        if (!id && u.pathname) {
          const parts = u.pathname.split('/');
          id = parts.pop() || parts.pop(); // last non-empty
        }
      }
    }
  } catch (err) {
    // ignore parse errors and keep raw
    console.warn('URL parse error, using raw value:', err);
  }

  // final cleanup: YouTube ids are 11 chars typically, but can be different.
  id = id.trim();
  // remove common prefix/suffix
  id = id.replace(/^.*(v=|\/|watch\?v=)/, '').split(/[?&/#]/)[0];

  if (!id) {
    videoWrap.innerHTML = '<div style="padding:12px;color:var(--muted)">Could not parse video id. Paste the full URL or the short id (e.g. Gfr50f6ZBvo).</div>';
    log('Preview failed: could not extract id from -> ' + raw);
    return;
  }

  // build embed URL
  const embedUrl = `https://www.youtube.com/embed/${encodeURIComponent(id)}?rel=0&modestbranding=1`;

  // Create iframe and insert
  const iframe = document.createElement('iframe');
  iframe.width = '100%';
  iframe.height = '160';
  iframe.src = embedUrl;
  iframe.frameBorder = '0';
  iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
  iframe.allowFullscreen = true;

  // Clear and append
  videoWrap.innerHTML = '';
  videoWrap.appendChild(iframe);

  // log and visual confirmation
  log('Preview loaded: ' + id + ' (embed url: ' + embedUrl + ')');
});


clearBtn.addEventListener('click', ()=>{
  videoIdEl.value = '';
  questionEl.value = '';
  setAnswer('No answer yet — ask NebulaAI.');
  setSummary('');
  log('Cleared fields');
});

copyBtn.addEventListener('click', async ()=>{
  try{
    await navigator.clipboard.writeText(answerTextEl.textContent || summaryTextEl.textContent || '');
    log('Answer copied to clipboard');
  }catch(e){ log('Copy failed: '+e); alert('Copy failed'); }
});

downloadBtn.addEventListener('click', ()=>{
  const text = 'Answer:\n\n' + (answerTextEl.textContent||'') + '\n\nSummary:\n\n' + (summaryTextEl.textContent||'');
  const blob = new Blob([text], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'nebula_answer.txt';
  document.body.appendChild(a); a.click(); a.remove();
  log('Downloaded answer');
});

toggleSummaryBtn.addEventListener('click', ()=>{
  if(summaryCard.classList.contains('show')){
    summaryCard.classList.remove('show');
    toggleSummaryBtn.textContent = 'Show Summary';
  } else {
    summaryCard.classList.add('show');
    toggleSummaryBtn.textContent = 'Hide Summary';
  }
});

// Ask Nebula — main action with minimum overlay time handling
askBtn.addEventListener('click', async ()=>{
  const video_id = videoIdEl.value.trim();
  const question = questionEl.value.trim();
  if(!video_id){ alert('Please enter a YouTube video id'); return; }
  if(!question){ alert('Please enter a question'); return; }

  setAnswer(''); setSummary('');
  log(`Sending request -> video=${video_id}, question="${question}"`);

  // show overlay & remember start time
  const start = Date.now();
  showOverlay();

  try{
    const respPromise = fetch('/api/ask', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({video_id, question})
    });

    const resp = await respPromise;
    log(`HTTP ${resp.status} ${resp.statusText}`);

    // parse JSON (may throw)
    let data;
    try {
      data = await resp.json();
    } catch(e){
      const txt = await resp.text();
      log('Failed to parse JSON from backend: ' + txt);
      setAnswer('Error: backend returned non-JSON response. See debug log.');
      return;preview
    }

    if(!resp.ok || data.ok === false){
      log('Backend error: ' + (data.error || JSON.stringify(data)));
      setAnswer('Error from backend: ' + (data.error || resp.statusText));
      setSummary(data.summary || '');
      return;
    }

    // success: display
    setAnswer(data.answer || '[no answer returned]');
    setSummary(data.summary || '');
    log('Received answer & summary (answer length = ' + ((data.answer||'').length) + ')');
    // ensure summary hidden initially
    if(summaryCard.classList.contains('show')){
      // keep as user left it
    } else {
      summaryCard.classList.remove('show');
      toggleSummaryBtn.textContent = 'Show Summary';
    }

  } catch(err){
    log('Network error: ' + err);
    setAnswer('Network error: ' + (err && err.message ? err.message : String(err)));
  } finally{
    // ensure overlay visible at least minShowMs
    const elapsed = Date.now() - start;
    const remaining = Math.max(0, minShowMs - elapsed);
    setTimeout(()=>{ hideOverlay(); }, remaining);
  }
});

// keyboard quick submit: Ctrl/Cmd+Enter
questionEl.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && (e.ctrlKey || e.metaKey)) askBtn.click();
});

// defaults
videoIdEl.value = videoIdEl.value || 'Gfr50f6ZBvo';
questionEl.value = questionEl.value || 'summary';

</script>
</body>
</html>
